---
title: "Gnotobiotic Mix-Reconv Loperamide CFUs"
author: "Rebecca Stevick/David Perez Pascual"
output:
  html_document:
    toc: true
    keep_md: TRUE
    theme: "cerulean"
    toc_float:
      collapsed: false
      smooth_scroll: false
---

# About the Data

## Timepoints

Treat with loperamide at 5 dpf for 24 hours.

-   Sample timepoint 1 at 6 dpf (24 hour treatment)
-   Sample timepoint 2 at 7 dpf (24 hour treatment + 24 hour water)
-   Sample timepoint 3 at 11 dpf (24 hour treatment + 5 days water)

### Sample collection & plating

At each timepoint:

1.  Wash all fish twice by transferring into sterile volvic in a 6-well plate
2.  Add fish with 500 µL sterile volvic water into a fastprep tube
3.  Homogenize sample at 6.5 for 45 seconds

Make 3 dilutions in 1.5 mL tubes: 100 µL into 900 µL water --\> 10^0^, 10^-1^, 10^-2^, 10^-3^\
Spread 3 x 100 µL aliquots of each dilution on LB plates = 12 plates per fish\
144 plates total per timepoint

Put plates at 28C for 2 days, then count colonies.

### Conditions

|  Treatment (Strain)  | Loperamide Treatment |
|:--------------------:|:--------------------:|
| Bc1/Bc2/Bc3/Bc4/Bc10 |                      |
| Bc1/Bc2/Bc3/Bc4/Bc10 |         DMSO         |
| Bc1/Bc2/Bc3/Bc4/Bc10 |  Loperamide 10 mg/L  |

# Setup

## Load libraries

```{r setup, warning=FALSE, message=FALSE, echo=FALSE}
library(tidyverse)
library(scales)
library(ggpubr)
library(ungeviz)
library(rmdformats)
library(vegan)
library(patchwork)
library(ggtext)

theme_set(theme_minimal()+
theme(panel.grid.major.y = element_line(color="grey80"), strip.text=element_text(size=16),
        strip.text.y = element_text(angle=0), plot.caption = element_text(size=10),
        panel.grid.major.x = element_blank(),legend.position="top",
        plot.background = element_rect(fill="transparent", color="transparent"),
        axis.ticks = element_line(inherit.blank = FALSE),
        panel.background = element_rect(color="grey50", size=2), 
        legend.title = element_text(size=18),
        axis.text = element_text(size=15), axis.title = element_text(size=18),
        legend.text = element_text(size=16), plot.title = element_text(hjust=0.5)))

scientific_10 <- function(x) {ifelse(x==0, "0", parse(text=gsub("[+]", "", gsub("e", " %*% 10^", scientific_format()(x)))))}

knitr::opts_chunk$set(warning=FALSE,message=FALSE)

```

## Import data

```{r import, echo=TRUE}

# import mix data
datacfusmix <- 
   readxl::read_xlsx("MixCFUs_LoperamideZebrafish.xlsx", sheet="FishMix") %>%
   drop_na(DF) %>%
   mutate(LoperamideTreatment=factor(LoperamideTreatment, 
                                     levels=c("None", "DMSO", "Loperamide 10 mg/L"),
                                     labels=c("Control","DMSO", "Loperamide"))) %>% 
  group_by(Fish,Treatment,LoperamideTreatment,FishNum,TrialDay, Timepoint) %>% 
  summarise_all(.funs="mean", na.rm=TRUE) %>% 
   unite("LoperamideTimepoint", LoperamideTreatment,Timepoint, remove=FALSE) %>% 
   unite("FishID", LoperamideTreatment,Timepoint,FishNum, remove=FALSE)


# import strain metadata
straininfo <- readxl::read_xlsx("../../LoperamideStrainInfo.xlsx")

```

------------------------------------------------------------------------


# Mix fish colonization

## Total CFUs

```{r mixtotalcfus, fig.height=4, fig.width=8}

mixtotalCFUplot <- datacfusmix %>% 
  ggplot(aes(x=Timepoint, y=CFUs_perFish, 
             fill=LoperamideTreatment, color=LoperamideTreatment, shape=LoperamideTreatment))+
  geom_boxplot(color="black", alpha=0.8, show.legend = FALSE)+
  geom_point(size=2, position=position_jitterdodge(jitter.width=0.3)) +
   scale_color_manual(values=c('#000000', '#1c5580', '#0fc08e'))+
   scale_fill_manual(values=c('#000000', '#1c5580', '#0fc08e'))+
  scale_y_continuous(trans = 'log10', limits=c(5e2,5e5), 
                     labels = trans_format('log10', math_format(10^.x)))+
  theme(legend.position = "none")+
  labs(y="Total CFUs per fish", x=NULL, fill=NULL, color=NULL, shape=NULL)+
   theme(legend.position = "right",legend.direction = "vertical", 
         panel.background = element_rect(size=1),
         legend.text = element_markdown(size=22))+
   guides(color=guide_legend(override.aes = list(size=4)))
mixtotalCFUplot

```



## Percent abundance of each strain per fish

```{r straintotal, warning=FALSE, fig.width=10}
library(ggh4x)

percentplot <- datacfusmix %>% 
   pivot_longer(Bc1perFish:Bc10perFish) %>% 
   mutate(name=factor(name,
                      levels=c("Bc2perFish","Bc10perFish","Bc3perFish","Bc4perFish","Bc1perFish"),
                      labels=c("S1. *Pseudomonas mossellii*",
                               "S3. *Pseudomonas nitroreducens*",
                               "S5. *Stenotrophomonas maltophila*",
                               "S6. *Aeromonas caviae*",
                               "S7. *Aeromonas veronii*"))) %>% 
   ggplot(aes(x=as.factor(FishNum), y=value, fill=name))+
   geom_col(position="fill")+
   facet_nested(.~Timepoint+LoperamideTreatment, space="free", scales="free")+
   scale_y_continuous(labels=scales::label_percent(sale=1))+
   scale_fill_manual(values = rev(nationalparkcolors::park_palette("Saguaro", 5)))+
   labs(x=NULL, y="CFUs per strain \n(% of total CFUs per fish)", fill=NULL)+
   theme(strip.text=element_text(size=15), axis.text.x = element_blank(),
         axis.ticks.x = element_blank(),
         strip.background = element_rect(fill="grey85", color="white"),
         legend.position = "bottom", legend.direction = "vertical",
         panel.background = element_blank(),
         legend.text = element_markdown(size=22))
percentplot

```

## Summary figure

```{r strainpercent, warning=FALSE, fig.width=15}

library(cowplot)
percentlegend <- get_legend(percentplot)
cfulegend <- get_legend(mixtotalCFUplot)

legends <- plot_grid(cfulegend, percentlegend, ncol=1, axis = "l")

((mixtotalCFUplot+legends + plot_layout(widths=c(2,4)))  /
      percentplot) +plot_annotation(tag_levels = list(c('A','','B')))  &
   theme(legend.position="none", plot.tag = element_text(face = "bold", size=20))

ggsave("Figure5_MixReconvPlots.png", width=14.5, height=8)
ggsave("Figure5_MixReconvPlots.pdf", width=14.5, height=8)
ggsave("Figure5_MixReconvPlots.tiff", width=14.5, height=8)

```


# Alpha diversity

```{r alphasimp, fig.width=6, fig.height=3}

matrixcfusmix<- datacfusmix %>% ungroup() %>% 
   unite("FishID", LoperamideTreatment,Timepoint,FishNum) %>% 
   select(FishID, Bc1perFish:Bc10perFish) %>% 
   column_to_rownames(var="FishID") %>% as.matrix()

datacfusmix$Simpsons<-diversity(matrixcfusmix, index="simpson")

statsSimpsonsMix <-  compare_means(data=datacfusmix, 
                            Simpsons~LoperamideTreatment, 
                            group.by = c("Timepoint")) %>% 
   filter(p.format<0.05 & group1=="DMSO")

mixalpha <- datacfusmix%>% 
   ggplot(aes(x=Timepoint, y=Simpsons, 
             fill=LoperamideTreatment, color=LoperamideTreatment, shape=LoperamideTreatment))+
   geom_boxplot(color="black", alpha=0.8, show.legend = FALSE)+
   geom_point(size=2, position=position_jitterdodge(jitter.width=0.3)) +
   geom_text(data=statsSimpsonsMix, aes(label="*", x=Timepoint, 
                                        y=0.9, fill=NA, shape=NA), 
             size=9, color="#0fc08e", show.legend=FALSE, nudge_x=.25)+
   scale_color_manual(values=c('#000000', '#1c5580', '#0fc08e'))+
   scale_fill_manual(values=c('#000000', '#1c5580', '#0fc08e'))+
   scale_y_continuous(limits=c(0,1.0), expand=c(0,0))+
   theme(legend.position = "none")+
   labs(x=NULL, y="Simpson's Index of Diversity",fill=NULL, shape=NULL, color=NULL,
        title="Mix gnotobiotic fish")+
   theme(legend.position = "bottom", plot.title = element_text(size=20),
         panel.background = element_rect(color="grey80", size=0.8))+
   guides(color=guide_legend(override.aes = list(size=4)))
mixalpha
```

## Summary figure

Get conventional panel from 16S script

```{r alhpasimpconv, eval=FALSE}

convalpha2 + mixalpha + labs(y=NULL) + 
   plot_layout(guides="collect")+plot_annotation(tag_levels = "A") & 
   theme(legend.position="bottom",plot.tag = element_text(face = "bold", size=20))
ggsave("Figure6_AlphaDiversity_Conv_Mix5.png", bg="transparent", width = 8, height = 5)
ggsave("Figure6_AlphaDiversity_Conv_Mix5.pdf", bg="transparent", width = 8, height = 5)
ggsave("Figure6_AlphaDiversity_Conv_Mix5.tiff", bg="transparent", width = 8, height = 5)

```



------------------------------------------------------------------------

# Compare with Mono as a mix


## Import Mono data for these strains

```{r importmono}

datamonocfus <-
   readxl::read_xlsx("../Mono/MonoCFUs_LoperamideZebrafish.xlsx", sheet="Trial49") %>%
   drop_na(DF) %>%
   mutate(LoperamideTreatment=factor(LoperamideTreatment, 
                                    levels=c("None", "DMSO", "Loperamide 10 mg/L"),
                                    labels=c("Control","DMSO", "Loperamide")),
         Treatment = factor(Treatment,
                            levels=c("Bc1","Bc2","Bc3","Bc4","Bc10")))

```


## Mono plots

```{r monomixcfus, warning=FALSE, fig.width=15, fig.height=10}
percentmono <- datamonocfus %>% left_join(straininfo, by=c("Treatment" = "Strain")) %>% 
   group_by(Timepoint, LoperamideTreatment, CodeName) %>% 
   summarise(meanCFUs=mean(CFUs_perFish), sdCFUs=sd(CFUs_perFish)) %>% 
   ggplot(aes(x=LoperamideTreatment, y=meanCFUs, fill=CodeName))+
   geom_col(position="fill")+
   facet_grid(.~Timepoint, space="free", scales="free")+
   theme(legend.text = element_markdown(), legend.position = "right")+
   scale_y_continuous(labels=scales::label_percent())+ #limits=c(0,1e6))+ #
   scale_fill_manual(values = rev(nationalparkcolors::park_palette("Saguaro", 5)))+
   labs(x=NULL, y="mean CFUs per strain \n(% of total CFUs per condition)", fill="Strain",
        title="Mono-reconv means as a mix")

abundmono <- datamonocfus  %>% left_join(straininfo, by=c("Treatment" = "Strain")) %>% 
   group_by(Timepoint, LoperamideTreatment, Treatment, CodeName) %>% 
   summarise(meanCFUs=mean(CFUs_perFish), sdCFUs=sd(CFUs_perFish)) %>% 
   mutate(Treatment=factor(Treatment, levels=c("Bc1","Bc2","Bc3","Bc4","Bc10"))) %>% 
   ggplot(aes(x=LoperamideTreatment, y=meanCFUs, fill=CodeName))+
   geom_col(position=position_dodge(width=0.8), width=0.8)+
   geom_errorbar(aes(ymin=pmax(meanCFUs-sdCFUs,0), ymax=meanCFUs+sdCFUs),
                 position=position_dodge(width=0.8),width=0.2)+
   facet_grid(.~Timepoint, space="free", scales="free")+
    theme(legend.text = element_markdown(), legend.position = "right")+
   scale_y_continuous(trans = 'log10', expand=c(0,0),limits=c(NA,2e6),
                      labels = trans_format('log10', math_format(10^.x)))+
   scale_fill_manual(values = rev(nationalparkcolors::park_palette("Saguaro", 5)))+
   labs(x=NULL, y="mean CFUs per strain \n(% of total CFUs per condition)", fill="Strain",
        title="Mono-reconv means as a mix")

percentmono/abundmono+plot_layout(guides="collect") &
  theme(legend.position='bottom')

```

## Mix plots

```{r straintotalmean, warning=FALSE, fig.width=15, fig.height=10}

percentmix<- datacfusmix  %>% 
   pivot_longer(Bc1perFish:Bc10perFish) %>% 
   mutate(name=factor(name,
                      levels=c("Bc1perFish","Bc2perFish","Bc3perFish","Bc4perFish","Bc10perFish"),
                      labels=c("Bc1","Bc2","Bc3","Bc4","Bc10"))) %>% 
   left_join(straininfo, by=c("name" = "Strain")) %>% 
   group_by(LoperamideTreatment, Timepoint, CodeName) %>% 
   summarise(meanCFUs=mean(value)) %>% 
   ggplot(aes(x=LoperamideTreatment, y=meanCFUs, fill=CodeName))+
   geom_col(position="fill")+
   facet_grid(.~Timepoint, space="free", scales="free")+
   scale_y_continuous(labels=scales::label_percent())+ #limits=c(0,1e6))+ #
   scale_fill_manual(values = rev(nationalparkcolors::park_palette("Saguaro", 5)))+
   theme(legend.text = element_markdown(), legend.position = "right")+
   labs(x=NULL, y="CFUs per strain \n(% of total CFUs per fish)", fill="Strain",
        title="Mix-reconv means per condition/timepoint")

abundmix <- datacfusmix %>% 
   pivot_longer(Bc1perFish:Bc10perFish) %>% 
   mutate(name=factor(name,
                      levels=c("Bc1perFish","Bc2perFish","Bc3perFish","Bc4perFish","Bc10perFish"),
                      labels=c("Bc1","Bc2","Bc3","Bc4","Bc10"))) %>% 
   left_join(straininfo, by=c("name" = "Strain")) %>% 
   group_by(CodeName, LoperamideTreatment, Timepoint) %>% 
   summarise(meanCFUs=mean(value), sdCFUs=sd(value)) %>% 
   ggplot(aes(x=LoperamideTreatment, y=meanCFUs, fill=CodeName))+
   geom_col(position=position_dodge(width=0.8), width=0.8)+
   geom_errorbar(aes(ymin=pmax(meanCFUs-sdCFUs,0), ymax=meanCFUs+sdCFUs),
                 position=position_dodge(width=0.8),width=0.2)+
   facet_grid(.~Timepoint, space="free", scales="free")+
   scale_y_continuous(trans = 'log10', expand=c(0,0),limits=c(NA,2e6),
                      labels = trans_format('log10', math_format(10^.x)))+
   theme(legend.text = element_markdown(), legend.position = "right")+
   scale_fill_manual(values = rev(nationalparkcolors::park_palette("Saguaro", 5)))+
   labs(x=NULL, y="CFUs per strain \n(% of total CFUs per fish)", fill="Strain",
        title="Mix-reconv means per condition/timepoint")

percentmix/abundmix+plot_layout(guides="collect") &
  theme(legend.position='bottom')

```


## Summary figure

```{r mixmonosummary, fig.width=20, fig.height=15}

percentmix+percentmono+
   (abundmix+labs(title=NULL))+(abundmono+labs(title=NULL)) +
   plot_layout(guides="collect", nrow=2) + plot_annotation(tag_levels = "A") &
   theme(legend.position='bottom',plot.title = element_text(size=30),
         legend.text = element_markdown(size=20),
         plot.tag = element_text(face = "bold", size=20)) & 
   guides(fill = guide_legend(ncol = 3))

ggsave("FigureS9_CompareMonoMixReconv.png", width=21, height=12, dpi=400)
ggsave("FigureS9_CompareMonoMixReconv.pdf", width=21, height=12)
ggsave("FigureS9_CompareMonoMixReconv.tiff", width=21, height=12)

```
Sum of the mono-reconv does not equal the mix-reconv.  
Also, increased colonization for each strain in mono-reconv than when part of a mix.


